services:
  kafka:
    image: apache/kafka:4.1.0
    container_name: kafka
    ports:
      - "9092:9092"        # 外部客户端连接端口
      - "29092:29092"      # 内部 Docker 网络连接端口（可选）
    environment:
      KAFKA_ENABLE_KRAFT: yes # kraft字段
      KAFKA_NODE_ID: 1     # kafka节点ID
      KAFKA_PROCESS_ROLES: broker,controller
      KAFKA_CONTROLLER_QUORUM_VOTERS: "1@kafka:29093"

      # Listener 配置（更稳定）
      # kafka 监听哪些端口 PLAINTEXT - 客户端发送消息的端口 CONTROLLER - Kafka 节点之间选主通信使用
      KAFKA_LISTENERS: "PLAINTEXT://0.0.0.0:9092,CONTROLLER://0.0.0.0:29093"
      # 告诉外部客户端要连接的地址
      KAFKA_ADVERTISED_LISTENERS: "PLAINTEXT://localhost:9092"

      # Listener 安全协议映射
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: "CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT"

      # Controller
      KAFKA_CONTROLLER_LISTENER_NAMES: CONTROLLER

      # 副本因子配置（单节点必须设置为1）
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1

      # Kafka 数据目录
      KAFKA_LOG_DIRS: "/tmp/kraft-combined-logs"

      # 自动创建 topic
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: "true"

      # 集群 ID（建议固定）
      CLUSTER_ID: "xYzabcDEF1234567890abc"
    volumes:
      - ./kafka-data:/tmp/kraft-combined-logs
    restart: unless-stopped

  clickhouse:
    image: clickhouse/clickhouse-server:24.8
    container_name: clickhouse
    ports:
      - "8123:8123"   # HTTP 端口（用于 REST API）
      - "9000:9000"   # Native 协议端口（客户端连接）
    environment:
      # 数据库配置
      CLICKHOUSE_DB: solana_holders
      CLICKHOUSE_USER: ken
      CLICKHOUSE_PASSWORD: 123456
      CLICKHOUSE_DEFAULT_ACCESS_MANAGEMENT: 1
    volumes:
      - ./clickhouse-data:/var/lib/clickhouse
      - ./clickhouse-logs:/var/log/clickhouse-server
    ulimits:
      nofile:
        soft: 262144
        hard: 262144
    healthcheck:
      test: ["CMD", "clickhouse-client", "--query", "SELECT 1"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

volumes:
  redis_data:
